<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Simple IMS — Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="app">
    <!-- AUTH -->
    <div id="auth" class="card">
      <h2>Inventory System</h2>

      <div id="auth-forms">
        <div id="login-form">
          <input id="login-email" placeholder="Email" />
          <input id="login-password" placeholder="Password" type="password" />
          <button onclick="login()">Login</button>
          <div class="small-links">
            <a href="#" onclick="showSignup()">Create account</a> |
            <a href="#" onclick="showReset()">Forgot password</a>
          </div>
        </div>

        <div id="signup-form" style="display:none">
          <input id="signup-name" placeholder="Full name" />
          <input id="signup-email" placeholder="Email" />
          <input id="signup-password" placeholder="Password" type="password" />
          <button onclick="signup()">Sign up</button>
          <div class="small-links">
            <a href="#" onclick="showLogin()">Already have account?</a>
          </div>
        </div>

        <div id="reset-form" style="display:none">
          <input id="reset-email" placeholder="Enter your email" />
          <button onclick="requestOtp()">Send OTP (demo)</button>
          <div class="small-links">
            <a href="#" onclick="showLogin()">Back to login</a>
          </div>
        </div>

        <div id="otp-form" style="display:none">
          <input id="otp-email" placeholder="Email" />
          <input id="otp-code" placeholder="Enter OTP" />
          <input id="otp-newpass" placeholder="New password" type="password" />
          <button onclick="resetPassword()">Reset Password</button>
        </div>
      </div>
    </div>

    <!-- MAIN APP -->
    <div id="main" style="display:none">
      <aside class="sidebar">
        <h3>StockMaster</h3>
        <nav>
          <a href="#" onclick="showSection('dashboard')">Dashboard</a>
          <a href="#" onclick="showSection('products')">Products</a>
          <a href="#" onclick="showSection('receipts')">Receipts</a>
          <a href="#" onclick="showSection('deliveries')">Deliveries</a>
          <a href="#" onclick="showSection('transfers')">Transfers</a>
          <a href="#" onclick="showSection('adjustments')">Adjustments</a>
          <a href="#" onclick="showSection('history')">Move History</a>
          <a href="#" onclick="showSection('settings')">Settings</a>
        </nav>
        <div class="profile">
          <div id="profile-name"></div>
          <button onclick="logout()">Logout</button>
        </div>
      </aside>

      <main class="content">
        <section id="dashboard" class="section">
          <h2>Dashboard</h2>
          <div class="kpi-row">
            <div class="kpi" id="kpi-total">Total Products<br/><span>0</span></div>
            <div class="kpi" id="kpi-low">Low / Out of Stock<br/><span>0</span></div>
            <div class="kpi" id="kpi-pending-receipts">Pending Receipts<br/><span>0</span></div>
            <div class="kpi" id="kpi-pending-deliveries">Pending Deliveries<br/><span>0</span></div>
          </div>

          <div class="panel">
            <h3>Quick Actions</h3>
            <div class="grid-3">
              <button onclick="showSection('products')">Create Product</button>
              <button onclick="showSection('receipts')">New Receipt</button>
              <button onclick="showSection('deliveries')">New Delivery</button>
            </div>
          </div>
        </section>

        <!-- Products -->
        <section id="products" class="section" style="display:none">
          <h2>Products</h2>
          <div class="panel">
            <h4>Create / Update Product</h4>
            <input id="p-name" placeholder="Product name" />
            <input id="p-sku" placeholder="SKU / Code" />
            <input id="p-category" placeholder="Category" />
            <input id="p-uom" placeholder="Unit of Measure" />
            <input id="p-initial" type="number" placeholder="Initial stock (optional)" />
            <input id="p-location" placeholder="Location (e.g., Warehouse A)" />
            <button onclick="createProduct()">Save Product</button>
          </div>

          <div class="panel">
            <h4>Products List</h4>
            <input id="search-product" placeholder="Search SKU or name" oninput="loadProducts()" />
            <div id="products-list"></div>
          </div>
        </section>

        <!-- Receipts -->
        <section id="receipts" class="section" style="display:none">
          <h2>Receipts (Incoming)</h2>
          <div class="panel">
            <h4>Create Receipt</h4>
            <input id="r-supplier" placeholder="Supplier name" />
            <input id="r-location" placeholder="Receiving location" />
            <div id="receipt-lines">
              <div class="line">
                <input class="line-sku" placeholder="SKU" />
                <input class="line-qty" type="number" placeholder="Qty" />
              </div>
            </div>
            <button onclick="addReceiptLine()">Add line</button>
            <button onclick="createReceipt()">Create Receipt</button>
          </div>
        </section>

        <!-- Deliveries -->
        <section id="deliveries" class="section" style="display:none">
          <h2>Delivery Orders (Outgoing)</h2>
          <div class="panel">
            <h4>Create Delivery</h4>
            <input id="d-customer" placeholder="Customer name" />
            <input id="d-location" placeholder="Ship from location" />
            <div id="delivery-lines">
              <div class="line">
                <input class="d-line-sku" placeholder="SKU" />
                <input class="d-line-qty" type="number" placeholder="Qty" />
              </div>
            </div>
            <button onclick="addDeliveryLine()">Add line</button>
            <button onclick="createDelivery()">Create Delivery</button>
          </div>
        </section>

        <!-- Transfers -->
        <section id="transfers" class="section" style="display:none">
          <h2>Internal Transfers</h2>
          <div class="panel">
            <input id="t-sku" placeholder="SKU" />
            <input id="t-from" placeholder="From location" />
            <input id="t-to" placeholder="To location" />
            <input id="t-qty" type="number" placeholder="Qty" />
            <button onclick="createTransfer()">Create Transfer</button>
          </div>
        </section>

        <!-- Adjustments -->
        <section id="adjustments" class="section" style="display:none">
          <h2>Stock Adjustments</h2>
          <div class="panel">
            <input id="a-sku" placeholder="SKU" />
            <input id="a-location" placeholder="Location" />
            <input id="a-count" type="number" placeholder="Counted quantity" />
            <input id="a-reason" placeholder="Reason (e.g., damage)" />
            <button onclick="createAdjustment()">Adjust Stock</button>
          </div>
        </section>

        <!-- History -->
        <section id="history" class="section" style="display:none">
          <h2>Move History / Ledger</h2>
          <div id="history-list"></div>
        </section>

        <section id="settings" class="section" style="display:none">
          <h2>Settings</h2>
          <div class="panel">
            <p>Multi-warehouse, reordering rules and other settings would go here (demo).</p>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    const API='backend.php';

    // UI helpers
    function showSignup(){ document.getElementById('login-form').style.display='none'; document.getElementById('signup-form').style.display='block'; document.getElementById('reset-form').style.display='none'; document.getElementById('otp-form').style.display='none';}
    function showLogin(){ document.getElementById('login-form').style.display='block'; document.getElementById('signup-form').style.display='none'; document.getElementById('reset-form').style.display='none'; document.getElementById('otp-form').style.display='none';}
    function showReset(){ document.getElementById('login-form').style.display='none'; document.getElementById('signup-form').style.display='none'; document.getElementById('reset-form').style.display='block'; document.getElementById('otp-form').style.display='none';}
    function showSection(id){
      document.getElementById('main').style.display='flex';
      for(const s of document.querySelectorAll('.section')) s.style.display='none';
      document.getElementById(id).style.display='block';
    }

    // AUTH
    async function signup(){
      const name = document.getElementById('signup-name').value;
      const email = document.getElementById('signup-email').value;
      const pass = document.getElementById('signup-password').value;
      const res = await post({action:'signup',name,email,pass});
      alert(res.message);
      if(res.success) showLogin();
    }

    async function login(){
      const email = document.getElementById('login-email').value;
      const pass = document.getElementById('login-password').value;
      const res = await post({action:'login',email,pass});
      if(res.success) {
        document.getElementById('auth').style.display='none';
        document.getElementById('main').style.display='flex';
        document.getElementById('profile-name').innerText = res.user.name;
        loadDashboard();
        loadProducts();
      } else alert(res.message);
    }

    async function requestOtp(){
      const email = document.getElementById('reset-email').value;
      const res = await post({action:'send_otp',email});
      alert(res.message + (res.otp?(' (demo OTP: '+res.otp+')'):''));
      if(res.success){
        document.getElementById('otp-form').style.display='block';
        document.getElementById('otp-email').value=email;
      }
    }

    async function resetPassword(){
      const email = document.getElementById('otp-email').value;
      const code = document.getElementById('otp-code').value;
      const newpass = document.getElementById('otp-newpass').value;
      const res = await post({action:'reset_password',email,code,newpass});
      alert(res.message);
      if(res.success) showLogin();
    }

    async function logout(){
      await post({action:'logout'});
      document.getElementById('main').style.display='none';
      document.getElementById('auth').style.display='block';
      showLogin();
    }

    // PRODUCTS
    async function createProduct(){
      const payload = {
        action:'create_product',
        name:document.getElementById('p-name').value,
        sku:document.getElementById('p-sku').value,
        category:document.getElementById('p-category').value,
        uom:document.getElementById('p-uom').value,
        initial:document.getElementById('p-initial').value||0,
        location:document.getElementById('p-location').value||'Default'
      };
      const res = await post(payload);
      alert(res.message);
      if(res.success) { loadProducts(); loadDashboard(); }
    }

    async function loadProducts(){
      const q = document.getElementById('search-product')?.value || '';
      const res = await post({action:'list_products',q});
      const container = document.getElementById('products-list');
      container.innerHTML = '';
      if(!res.success) return container.innerText='No products';
      res.data.forEach(p=>{
        const div = document.createElement('div');
        div.className='row';
        div.innerHTML = `<strong>${p.name}</strong> (${p.sku}) - ${p.category} - ${p.uom}
          <br/>Locations: ${Object.entries(p.locations||{}).map(([loc,qty])=>loc+': '+qty).join(' | ')}
          <br/><button onclick="quickAdjust('${p.sku}')">Adjust</button>`;
        container.appendChild(div);
      });
    }

    function quickAdjust(sku){
      const qty = prompt('Enter counted qty for SKU '+sku);
      const loc = prompt('Enter location (e.g., Warehouse A)','Default');
      const reason = prompt('Reason','count');
      if(qty!==null) {
        createAdjustmentManual(sku,loc,qty,reason);
      }
    }

    // RECEIPTS
    function addReceiptLine(){
      const div = document.createElement('div');
      div.className='line';
      div.innerHTML = `<input class="line-sku" placeholder="SKU" /><input class="line-qty" type="number" placeholder="Qty" />`;
      document.getElementById('receipt-lines').appendChild(div);
    }

    async function createReceipt(){
      const supplier = document.getElementById('r-supplier').value;
      const location = document.getElementById('r-location').value||'Default';
      const lines = Array.from(document.querySelectorAll('#receipt-lines .line')).map(l=>({
        sku: l.querySelector('.line-sku').value,
        qty: Number(l.querySelector('.line-qty').value||0)
      })).filter(x=>x.sku && x.qty>0);
      if(!lines.length){ alert('Add at least one line'); return; }
      const res = await post({action:'create_receipt',supplier,location,lines});
      alert(res.message);
      if(res.success){ loadProducts(); loadDashboard(); }
    }

    // DELIVERIES
    function addDeliveryLine(){
      const div = document.createElement('div');
      div.className='line';
      div.innerHTML = `<input class="d-line-sku" placeholder="SKU" /><input class="d-line-qty" type="number" placeholder="Qty" />`;
      document.getElementById('delivery-lines').appendChild(div);
    }

    async function createDelivery(){
      const customer = document.getElementById('d-customer').value;
      const location = document.getElementById('d-location').value||'Default';
      const lines = Array.from(document.querySelectorAll('#delivery-lines .line')).map(l=>({
        sku: l.querySelector('.d-line-sku').value,
        qty: Number(l.querySelector('.d-line-qty').value||0)
      })).filter(x=>x.sku && x.qty>0);
      if(!lines.length){ alert('Add lines'); return; }
      const res = await post({action:'create_delivery',customer,location,lines});
      alert(res.message);
      if(res.success){ loadProducts(); loadDashboard(); }
    }

    // TRANSFERS
    async function createTransfer(){
      const sku=document.getElementById('t-sku').value;
      const from=document.getElementById('t-from').value;
      const to=document.getElementById('t-to').value;
      const qty=Number(document.getElementById('t-qty').value||0);
      const res = await post({action:'create_transfer',sku,from,to,qty});
      alert(res.message);
      if(res.success){ loadProducts(); loadDashboard(); loadHistory(); }
    }

    // ADJUSTments
    async function createAdjustment(){
      const sku=document.getElementById('a-sku').value;
      const loc=document.getElementById('a-location').value||'Default';
      const count=Number(document.getElementById('a-count').value||0);
      const reason=document.getElementById('a-reason').value||'adjustment';
      const res = await post({action:'create_adjustment',sku,loc,count,reason});
      alert(res.message);
      if(res.success){ loadProducts(); loadDashboard(); loadHistory(); }
    }
    async function createAdjustmentManual(sku,loc,count,reason){
      const res = await post({action:'create_adjustment',sku,loc,count,reason});
      alert(res.message);
      if(res.success){ loadProducts(); loadDashboard(); loadHistory(); }
    }

    // History & Dashboard
    async function loadHistory(){
      const res = await post({action:'get_history'});
      const c = document.getElementById('history-list');
      c.innerHTML = '';
      if(!res.success) return c.innerText='No history';
      res.data.slice().reverse().forEach(h=>{
        const d = document.createElement('div');
        d.className='row';
        d.innerHTML = `<strong>${h.type}</strong> — ${h.details} <br/>By: ${h.by} @ ${new Date(h.time*1000).toLocaleString()}`;
        c.appendChild(d);
      });
    }

    async function loadDashboard(){
      const res = await post({action:'get_dashboard'});
      if(!res.success) return;
      document.getElementById('kpi-total').querySelector('span').innerText = res.total_products;
      document.getElementById('kpi-low').querySelector('span').innerText = res.low_stock;
      document.getElementById('kpi-pending-receipts').querySelector('span').innerText = res.pending_receipts;
      document.getElementById('kpi-pending-deliveries').querySelector('span').innerText = res.pending_deliveries;
      loadHistory();
    }

    // Generic helper
    async function post(payload){
      try{
        const r = await fetch(API, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        return await r.json();
      }catch(e){ console.error(e); return {success:false,message:'Server error'}; }
    }
  </script>
</body>
</html>
